// SPDX-License-Identifier: GPL-3.0-or-later
// SPDX-FileCopyrightText: 2015 Christian Hergert <christian@hergert.me>
// SPDX-FileCopyrightText: 2021 Andy Holmes <andrew.g.r.holmes@gmail.com>

#pragma once

#include <glib.h>

G_BEGIN_DECLS

/**
 * SECTION:valent-debug
 * @title: Debug logging and tracing
 * @short_description: tracing and debug facilities
 *
 * The profiling macros such as %VALENT_ENTRY, %VALENT_EXIT, and %VALENT_RETURN
 * provide helpers for tracing at runtime. The debug macros such as %VALENT_PROBE
 * and %VALENT_TRACE_MSG provide helpers for debugging and logging.
 *
 * These tracing macros will compile out when configured for a release build.
 */

/**
 * VALENT_LOG_LEVEL_TRACE: (skip)
 */
#ifndef VALENT_LOG_LEVEL_TRACE
# define VALENT_LOG_LEVEL_TRACE ((GLogLevelFlags)(1 << G_LOG_LEVEL_USER_SHIFT))
#endif


/*
 * Profiling Macros
 */
#ifndef VALENT_ENABLE_PROFILING
# define VALENT_ENABLE_PROFILING @VALENT_ENABLE_PROFILING@
#endif
#if VALENT_ENABLE_PROFILING != 1
# undef VALENT_ENABLE_PROFILING
#endif


#ifdef VALENT_ENABLE_PROFILING

extern
void valent_trace_mark (const char *strfunc,
                      gint64      begin_time_usec,
                      gint64      end_time_usec);

/**
 * VALENT_ENTRY: (skip)
 *
 * Traces the entry into a function. Place this at the beginning of your
 * function above pre-condition checks.
 */
# define VALENT_ENTRY                                                       \
   gint64 __trace_begin_time = g_get_monotonic_time ();                     \
   g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, "ENTRY: %s():%d",            \
           G_STRFUNC, __LINE__)

/**
 * VALENT_EXIT: (skip)
 *
 * Traces the exit from a function. Use this instead of "return" to return
 * and log the function exiting.
 */
# define VALENT_EXIT                                                        \
   G_STMT_START {                                                           \
      valent_trace_mark (G_STRFUNC,                                         \
                         __trace_begin_time,                                \
                         g_get_monotonic_time ());                          \
      g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, " EXIT: %s():%d",         \
            G_STRFUNC, __LINE__);                                           \
      return;                                                               \
   } G_STMT_END

/**
 * VALENT_RETURN: (skip)
 *
 * Similar to %VALENT_EXIT but allows providing a return value.
 */
# define VALENT_RETURN(_r)                                                  \
   G_STMT_START {                                                           \
      valent_trace_mark (G_STRFUNC,                                         \
                         __trace_begin_time,                                \
                         g_get_monotonic_time ());                          \
      g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, " EXIT: %s():%d ",        \
            G_STRFUNC, __LINE__);                                           \
      return _r;                                                            \
   } G_STMT_END
#else
# define VALENT_ENTRY               G_STMT_START {            } G_STMT_END
# define VALENT_EXIT                G_STMT_START { return;    } G_STMT_END
# define VALENT_RETURN(_r)          G_STMT_START { return _r; } G_STMT_END
#endif


/*
 * Debug Macros
 */
#ifndef VALENT_ENABLE_DEBUG
# define VALENT_ENABLE_DEBUG @VALENT_ENABLE_DEBUG@
#endif
#if VALENT_ENABLE_DEBUG != 1
# undef VALENT_ENABLE_DEBUG
#endif


#ifdef VALENT_ENABLE_DEBUG

/**
 * VALENT_DEBUG_PACKET: (skip)
 *
 * Pretty-print a #JsonNode for debugging purposes.
 */
# define VALENT_DEBUG_PACKET(pkt, ctx)                                      \
   G_STMT_START {                                                           \
     char *__json = json_to_string (pkt, TRUE);                             \
     g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, "PACKET: %s():%d %s: %s",  \
           G_STRFUNC, __LINE__, ctx, __json);                               \
     g_free(__json);                                                        \
   } G_STMT_END

/**
 * VALENT_TRACE_MSG: (skip)
 *
 * Similar to %VALENT_PROBE but allows specifying a log message.
 */
# define VALENT_TRACE_MSG(fmt, ...)                                         \
   g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, "  MSG: %s():%d: " fmt,      \
         G_STRFUNC, __LINE__, ##__VA_ARGS__)

/**
 * VALENT_PROBE: (skip)
 *
 * Appends to the tracing log that a line of code was reached.
 */
# define VALENT_PROBE                                                       \
   g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, "PROBE: %s():%d",            \
         G_STRFUNC, __LINE__)

/**
 * VALENT_TODO: (skip)
 * @_msg: the message to append to the trace log
 *
 * Appends to the tracing log that unsupported code has been reached.
 */
# define VALENT_TODO(_msg)                                                  \
   g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, " TODO: %s():%d: %s",        \
         G_STRFUNC, __LINE__, _msg)

/**
 * VALENT_GOTO: (skip)
 * @_l: the label to jump to
 *
 * Appends to the jump to label to the tracing log and then jumps
 * to the label @_l.
 */
# define VALENT_GOTO(_l)                                                    \
   G_STMT_START {                                                           \
      g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, " GOTO: %s():%d ("#_l")", \
            G_STRFUNC, __LINE__);                                           \
      goto _l;                                                              \
   } G_STMT_END

/**
 * VALENT_BACKTRACE: (skip)
 *
 * Print a backtrace to the tracing log.
 */
# define VALENT_BACKTRACE                                                   \
  G_STMT_START {                                                            \
    gpointer btbuf[64];                                                     \
    int btbuflen = backtrace (btbuf, G_N_ELEMENTS (btbuf));                 \
    char **symnames = backtrace_symbols (btbuf, btbuflen);                  \
    for (guint _i = 0; _i < btbuflen; _i++) {                               \
      g_log(G_LOG_DOMAIN, VALENT_LOG_LEVEL_TRACE, "TRACE: [%-2d]: %s",      \
            _i, symnames[_i]);                                              \
    }                                                                       \
    free (symnames);                                                        \
  } G_STMT_END
#else
# define VALENT_DEBUG_PACKET(packet, context) G_STMT_START {  } G_STMT_END
# define VALENT_TODO(_msg)          G_STMT_START {            } G_STMT_END
# define VALENT_PROBE               G_STMT_START {            } G_STMT_END
# define VALENT_TRACE_MSG(fmt, ...) G_STMT_START {            } G_STMT_END
# define VALENT_GOTO(_l)            G_STMT_START { goto _l;   } G_STMT_END
# define VALENT_BACKTRACE           G_STMT_START {            } G_STMT_END
#endif

G_END_DECLS

